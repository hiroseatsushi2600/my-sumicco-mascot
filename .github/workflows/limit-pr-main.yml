name: limit-main-pr

on:
  pull_request:
    branches:
      - main

jobs:
  check-branch:
    runs-on: ubuntu-latest
    steps:
      - name: Validate source branch
        id: validate
        run: |
          SRC="${{ github.head_ref }}"

          # 許可条件
          if [[ "$SRC" == "staging" || "$SRC" =~ ^bugfix/ ]]; then
            echo "Allowed: $SRC"
            echo "allowed=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "❌ PR from '$SRC' is not allowed to main."
          echo "Allowed branches: staging, bugfix/*"
          echo "allowed=false" >> $GITHUB_OUTPUT
          echo "message=❌ PR from '$SRC' is not allowed to main.%0AAllowed branches: staging, bugfix/*" >> $GITHUB_OUTPUT
          exit 1

      - name: Comment on PR
        if: steps.validate.outputs.allowed == 'false'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ${{ steps.validate.outputs.message }}
          edit-mode: replace
